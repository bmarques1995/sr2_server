From b6efa3fabaa843404403d644b6af369d669c6eed Mon Sep 17 00:00:00 2001
From: bmarques1995 <testebash@outlook.com>
Date: Fri, 19 Sep 2025 17:23:53 -0300
Subject: [PATCH] patch

---
 CMakeLists.txt             | 42 ++++++++++++++++++++++++++------------
 libmariadb/CMakeLists.txt  | 36 ++++++++++++++++++++++++++++----
 libmariadb/config.cmake.in |  3 +++
 3 files changed, 64 insertions(+), 17 deletions(-)
 create mode 100644 libmariadb/config.cmake.in

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 5e4a7198..69d6c9da 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -42,9 +42,9 @@ ADD_OPTION(WITH_BOOST_CONTEXT
   OFF)
 
 IF(WITH_BOOST_CONTEXT)
-  PROJECT(mariadb-connector-c LANGUAGES C CXX)
+  PROJECT(mariadb-connector-c LANGUAGES C CXX VERSION 3.4.7)
 ELSE()
-  PROJECT(mariadb-connector-c C)
+  PROJECT(mariadb-connector-c LANGUAGES C VERSION 3.4.7)
 ENDIF()
 
 SET(CC_SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR})
@@ -71,6 +71,8 @@ ELSE()
 ENDIF()
 
 ADD_OPTION(WITH_UNIT_TESTS "build test suite" ON)
+ADD_OPTION(WITH_NO_WARNING_TOLERANCE "build test suite" ON)
+ADD_OPTION(OVERRIDE_INSTALL_PATTERN "build test suite" OFF)
 ADD_OPTION(WITH_DYNCOL "Enables support of dynamic columns" ON)
 ADD_OPTION(WITH_EXTERNAL_ZLIB "Enables use of external zlib" OFF)
 ADD_OPTION(WITH_CURL "Enables use of curl" ON)
@@ -221,11 +223,24 @@ IF(NOT MARIADB_UNIX_ADDR)
   SET(MARIADB_UNIX_ADDR "/tmp/mysql.sock")
 ENDIF()
 
-INCLUDE("${CC_SOURCE_DIR}/cmake/install.cmake")
-IF(NOT PLUGINDIR)
-  SET(PLUGINDIR "${CMAKE_INSTALL_PREFIX}/${INSTALL_PLUGINDIR}")
+IF(OVERRIDE_INSTALL_PATTERN)
+  SET(INSTALL_BINDIR ${CMAKE_INSTALL_PREFIX}/bin)
+  SET(INSTALL_LIBDIR ${CMAKE_INSTALL_PREFIX}/lib)
+  SET(INSTALL_INCLUDEDIR ${CMAKE_INSTALL_PREFIX}/include)
+  IF(WIN32)
+    SET(INSTALL_PLUGINDIR ${INSTALL_BINDIR}/plugins)
+  ELSE()
+    SET(INSTALL_PLUGINDIR ${INSTALL_LIBDIR}/plugins)
+  ENDIF()
+  SET(INSTALL_PCDIR ${CMAKE_INSTALL_PREFIX}/lib/pkgconfig)
+ELSE()
+  INCLUDE("${CC_SOURCE_DIR}/cmake/install.cmake")
+  IF(NOT PLUGINDIR)
+    SET(PLUGINDIR "${CMAKE_INSTALL_PREFIX}/${INSTALL_PLUGINDIR}")
+  ENDIF()
 ENDIF()
 
+
 # todo: we don't character sets in share - all is compiled in
 SET(SHAREDIR "share")
 SET(DEFAULT_CHARSET_HOME "${CMAKE_INSTALL_PREFIX}")
@@ -416,16 +431,17 @@ ENDIF()
 MESSAGE1(SYSTEM_LIBS "SYSTEM_LIBS ${SYSTEM_LIBS}")
 MARK_AS_ADVANCED(SYSTEM_LIBS)
 
-IF(NOT IS_SUBPROJECT AND (NOT DEFINED CMAKE_COMPILE_WARNING_AS_ERROR))
-IF ((NOT WIN32) AND (CMAKE_C_COMPILER_ID MATCHES "Clang" OR CMAKE_C_COMPILER_ID MATCHES "GNU"))
-  SET(WARNING_AS_ERROR "-Werror")
-ELSEIF(CMAKE_C_COMPILER_ID MATCHES "MSVC")
-  SET(WARNING_AS_ERROR "/WX")
-ENDIF()
-SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${WARNING_AS_ERROR}")
+IF(WITH_NO_WARNING_TOLERANCE)
+  IF(NOT IS_SUBPROJECT AND (NOT DEFINED CMAKE_COMPILE_WARNING_AS_ERROR))
+  IF ((NOT WIN32) AND (CMAKE_C_COMPILER_ID MATCHES "Clang" OR CMAKE_C_COMPILER_ID MATCHES "GNU"))
+    SET(WARNING_AS_ERROR "-Werror")
+  ELSEIF(CMAKE_C_COMPILER_ID MATCHES "MSVC")
+    SET(WARNING_AS_ERROR "/WX")
+  ENDIF()
+  SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${WARNING_AS_ERROR}")
+  ENDIF()
 ENDIF()
 
-
 IF(NOT REMOTEIO_PLUGIN_TYPE MATCHES "OFF")
   IF(CURL_FOUND)
     INCLUDE_DIRECTORIES(${CURL_INCLUDE_DIRS})
diff --git a/libmariadb/CMakeLists.txt b/libmariadb/CMakeLists.txt
index 69e8683c..0780c7ab 100644
--- a/libmariadb/CMakeLists.txt
+++ b/libmariadb/CMakeLists.txt
@@ -455,6 +455,7 @@ ELSE()
 ENDIF()
 
 TARGET_LINK_LIBRARIES(libmariadb LINK_PRIVATE ${SYSTEM_LIBS} ${CRYPT_LIBS})
+TARGET_INCLUDE_DIRECTORIES(libmariadb PUBLIC $<INSTALL_INTERFACE:install>)
 
 SIGN_TARGET(libmariadb)
 
@@ -500,27 +501,54 @@ IF(NOT WIN32)
   SET_TARGET_PROPERTIES(mariadbclient PROPERTIES OUTPUT_NAME "${LIBMARIADB_STATIC_NAME}")
 ENDIF()
 
+set(MARIADB_GENERATED_DIR "${CMAKE_CURRENT_BINARY_DIR}/generated")
+set(MARIADB_VERSION_CONFIG "${MARIADB_GENERATED_DIR}/${PROJECT_NAME}ConfigVersion.cmake")
+set(MARIADB_PROJECT_CONFIG "${MARIADB_GENERATED_DIR}/${PROJECT_NAME}Config.cmake")
+set(MARIADB_TARGETS_EXPORT_NAME "${PROJECT_NAME}Targets")
+set(MARIADB_CONFIG_INSTALL_DIR "lib/cmake/${PROJECT_NAME}")
+set(MARIADB_NAMESPACE "${PROJECT_NAME}::")
+set(MARIADB_VERSION ${PROJECT_VERSION})
+
+include(CMakePackageConfigHelpers)
+write_basic_package_version_file(
+   "${MARIADB_VERSION_CONFIG}" VERSION ${MARIADB_VERSION} COMPATIBILITY SameMajorVersion
+)
+configure_file("${CMAKE_CURRENT_SOURCE_DIR}/config.cmake.in" "${MARIADB_PROJECT_CONFIG}" @ONLY)
+
+# Install cmake config files
+INSTALL(
+    FILES "${MARIADB_PROJECT_CONFIG}" "${MARIADB_VERSION_CONFIG}"
+    DESTINATION "${MARIADB_CONFIG_INSTALL_DIR}")
+
+INSTALL(
+    EXPORT "${MARIADB_TARGETS_EXPORT_NAME}"
+    NAMESPACE "${MARIADB_NAMESPACE}"
+    DESTINATION "${MARIADB_CONFIG_INSTALL_DIR}")
+
 INSTALL(TARGETS mariadbclient
           COMPONENT Development
           DESTINATION ${INSTALL_LIBDIR})
 IF(WIN32)
 INSTALL(TARGETS libmariadb
+        EXPORT ${MARIADB_TARGETS_EXPORT_NAME}
         COMPONENT SharedLibraries
-        DESTINATION ${INSTALL_LIBDIR})
+        RUNTIME DESTINATION ${INSTALL_BINDIR}
+        LIBRARY DESTINATION ${INSTALL_LIBDIR}
+        ARCHIVE DESTINATION ${INSTALL_LIBDIR})
 ELSE()
 # in cmake 3.12+ we can use
 #INSTALL(TARGETS libmariadb LIBRARY DESTINATION ${INSTALL_LIBDIR}
 #        COMPONENT SharedLibraries NAMELINK_COMPONENT Development)
 # but as long as we build on CentOS 7 with its cmake 2.8.12.2 we have to use
-INSTALL(TARGETS libmariadb LIBRARY DESTINATION ${INSTALL_LIBDIR}
+INSTALL(TARGETS libmariadb EXPORT ${MARIADB_TARGETS_EXPORT_NAME} LIBRARY DESTINATION ${INSTALL_LIBDIR}
         COMPONENT SharedLibraries NAMELINK_SKIP)
-INSTALL(TARGETS libmariadb LIBRARY DESTINATION ${INSTALL_LIBDIR}
+INSTALL(TARGETS libmariadb EXPORT ${MARIADB_TARGETS_EXPORT_NAME} LIBRARY DESTINATION ${INSTALL_LIBDIR}
         COMPONENT Development NAMELINK_ONLY)
 ENDIF()
 
 IF(MSVC)
    # On Windows, install PDB
-   INSTALL(FILES $<TARGET_PDB_FILE:libmariadb> DESTINATION "${INSTALL_LIBDIR}"
+   INSTALL(FILES $<TARGET_PDB_FILE:libmariadb> DESTINATION "${INSTALL_BINDIR}"
            CONFIGURATIONS Debug RelWithDebInfo
            COMPONENT Development)
 ENDIF()
diff --git a/libmariadb/config.cmake.in b/libmariadb/config.cmake.in
new file mode 100644
index 00000000..25b8747b
--- /dev/null
+++ b/libmariadb/config.cmake.in
@@ -0,0 +1,3 @@
+include(CMakeFindDependencyMacro)
+
+include("${CMAKE_CURRENT_LIST_DIR}/@MARIADB_TARGETS_EXPORT_NAME@.cmake")
-- 
2.49.0.windows.1

